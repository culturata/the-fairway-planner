// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User profile tied to Clerk user ID
model UserProfile {
  id          String   @id @default(cuid())
  clerkUserId String   @unique
  email       String?
  name        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tripMembers TripMember[]
  payments    Payment[]

  @@map("user_profiles")
}

// Trip entity (1:1 with Clerk Organization for MVP)
model Trip {
  id              String    @id @default(cuid())
  clerkOrgId      String    @unique
  name            String
  location        String?
  startDate       DateTime
  endDate         DateTime
  status          String    @default("DRAFT") // DRAFT, ACTIVE, COMPLETED
  handicapPct     Int       @default(100) // Handicap percentage (e.g., 100 = 100%)
  handicapCap     Int? // Optional handicap cap
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  members         TripMember[]
  itineraryItems  ItineraryItem[]
  rounds          Round[]
  costItems       TripCostItem[]
  announcements   Announcement[]

  @@map("trips")
}

// Trip membership with RSVP and handicap
model TripMember {
  id              String   @id @default(cuid())
  tripId          String
  userProfileId   String
  rsvpStatus      String   @default("INVITED") // INVITED, GOING, MAYBE, DECLINED
  handicap        Float?   // Manual handicap for this trip
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  trip            Trip         @relation(fields: [tripId], references: [id], onDelete: Cascade)
  userProfile     UserProfile  @relation(fields: [userProfileId], references: [id], onDelete: Cascade)
  scorecards      Scorecard[]
  teeGroupMembers TeeGroupMember[]

  @@unique([tripId, userProfileId])
  @@map("trip_members")
}

// Itinerary items (rounds, lodging, dinner, activities, etc.)
model ItineraryItem {
  id        String    @id @default(cuid())
  tripId    String
  type      String    // ROUND, LODGING, DINNER, ACTIVITY, TRAVEL, NOTE
  title     String
  startsAt  DateTime
  endsAt    DateTime?
  location  String?
  notes     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  trip      Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@map("itinerary_items")
}

// Round entity
model Round {
  id         String    @id @default(cuid())
  tripId     String
  courseName String
  teesName   String?
  startsAt   DateTime
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  trip       Trip       @relation(fields: [tripId], references: [id], onDelete: Cascade)
  teeGroups  TeeGroup[]
  scorecards Scorecard[]

  @@map("rounds")
}

// Tee groups (pairings)
model TeeGroup {
  id           String   @id @default(cuid())
  roundId      String
  label        String?  // e.g., "Group A", "Tee Time 1"
  teeTime      DateTime?
  startingHole Int?     // 1-18
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  round        Round             @relation(fields: [roundId], references: [id], onDelete: Cascade)
  members      TeeGroupMember[]

  @@map("tee_groups")
}

// Tee group members
model TeeGroupMember {
  id           String   @id @default(cuid())
  teeGroupId   String
  tripMemberId String
  createdAt    DateTime @default(now())

  teeGroup     TeeGroup   @relation(fields: [teeGroupId], references: [id], onDelete: Cascade)
  tripMember   TripMember @relation(fields: [tripMemberId], references: [id], onDelete: Cascade)

  @@unique([teeGroupId, tripMemberId])
  @@map("tee_group_members")
}

// Scorecard for a player in a round
model Scorecard {
  id           String   @id @default(cuid())
  roundId      String
  tripMemberId String
  status       String   @default("IN_PROGRESS") // IN_PROGRESS, SUBMITTED, LOCKED
  grossTotal   Int?
  netTotal     Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  round        Round      @relation(fields: [roundId], references: [id], onDelete: Cascade)
  tripMember   TripMember @relation(fields: [tripMemberId], references: [id], onDelete: Cascade)
  holeScores   HoleScore[]

  @@unique([roundId, tripMemberId])
  @@map("scorecards")
}

// Individual hole score
model HoleScore {
  id          String   @id @default(cuid())
  scorecardId String
  holeNumber  Int      // 1-18
  strokes     Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  scorecard   Scorecard @relation(fields: [scorecardId], references: [id], onDelete: Cascade)

  @@unique([scorecardId, holeNumber])
  @@map("hole_scores")
}

// Trip cost items (deposit, lodging, etc.)
model TripCostItem {
  id          String   @id @default(cuid())
  tripId      String
  name        String
  amountCents Int
  required    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  trip        Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  payments    Payment[]

  @@map("trip_cost_items")
}

// Payment records
model Payment {
  id                     String   @id @default(cuid())
  userProfileId          String
  tripCostItemId         String
  status                 String   @default("PENDING") // PENDING, PAID, FAILED, REFUNDED
  amountCents            Int
  stripeSessionId        String?  @unique
  stripePaymentIntentId  String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  userProfile            UserProfile  @relation(fields: [userProfileId], references: [id], onDelete: Cascade)
  tripCostItem           TripCostItem @relation(fields: [tripCostItemId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// Announcements
model Announcement {
  id        String   @id @default(cuid())
  tripId    String
  title     String?
  message   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  trip      Trip     @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@map("announcements")
}
